<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>pmQueue.mjs - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="wsemi.html">wsemi</a><ul class='methods'><li data-type='method'><a href="wsemi.html#.ab2blob">ab2blob</a></li><li data-type='method'><a href="wsemi.html#.ab2u8arr">ab2u8arr</a></li><li data-type='method'><a href="wsemi.html#.addMonth">addMonth</a></li><li data-type='method'><a href="wsemi.html#.aes2str">aes2str</a></li><li data-type='method'><a href="wsemi.html#.alive">alive</a></li><li data-type='method'><a href="wsemi.html#.arr2dt">arr2dt</a></li><li data-type='method'><a href="wsemi.html#.arraccum">arraccum</a></li><li data-type='method'><a href="wsemi.html#.arradd">arradd</a></li><li data-type='method'><a href="wsemi.html#.arrat">arrat</a></li><li data-type='method'><a href="wsemi.html#.arrfind">arrfind</a></li><li data-type='method'><a href="wsemi.html#.arrhas">arrhas</a></li><li data-type='method'><a href="wsemi.html#.b642obj">b642obj</a></li><li data-type='method'><a href="wsemi.html#.b642str">b642str</a></li><li data-type='method'><a href="wsemi.html#.b642u8arr">b642u8arr</a></li><li data-type='method'><a href="wsemi.html#.b642u16arr">b642u16arr</a></li><li data-type='method'><a href="wsemi.html#.binstr">binstr</a></li><li data-type='method'><a href="wsemi.html#.blob2ab">blob2ab</a></li><li data-type='method'><a href="wsemi.html#.blob2b64">blob2b64</a></li><li data-type='method'><a href="wsemi.html#.blob2str">blob2str</a></li><li data-type='method'><a href="wsemi.html#.blob2u8arr">blob2u8arr</a></li><li data-type='method'><a href="wsemi.html#.blobs2b64s">blobs2b64s</a></li><li data-type='method'><a href="wsemi.html#.blobs2u8arrs">blobs2u8arrs</a></li><li data-type='method'><a href="wsemi.html#.bodyLog">bodyLog</a></li><li data-type='method'><a href="wsemi.html#.bs2u8arr">bs2u8arr</a></li><li data-type='method'><a href="wsemi.html#.bufRead">bufRead</a></li><li data-type='method'><a href="wsemi.html#.bufReadDbl">bufReadDbl</a></li><li data-type='method'><a href="wsemi.html#.bufWrite">bufWrite</a></li><li data-type='method'><a href="wsemi.html#.bufWriteDbl">bufWriteDbl</a></li><li data-type='method'><a href="wsemi.html#.cache">cache</a></li><li data-type='method'><a href="wsemi.html#.cbol">cbol</a></li><li data-type='method'><a href="wsemi.html#.cdbl">cdbl</a></li><li data-type='method'><a href="wsemi.html#.cfilesize">cfilesize</a></li><li data-type='method'><a href="wsemi.html#.cfinancial">cfinancial</a></li><li data-type='method'><a href="wsemi.html#.cint">cint</a></li><li data-type='method'><a href="wsemi.html#.clearXSS">clearXSS</a></li><li data-type='method'><a href="wsemi.html#.cstr">cstr</a></li><li data-type='method'><a href="wsemi.html#.day2cht">day2cht</a></li><li data-type='method'><a href="wsemi.html#.debounce">debounce</a></li><li data-type='method'><a href="wsemi.html#.delay">delay</a></li><li data-type='method'><a href="wsemi.html#.dig">dig</a></li><li data-type='method'><a href="wsemi.html#.digExp">digExp</a></li><li data-type='method'><a href="wsemi.html#.domAppend">domAppend</a></li><li data-type='method'><a href="wsemi.html#.domCancelEvent">domCancelEvent</a></li><li data-type='method'><a href="wsemi.html#.domDetect">domDetect</a></li><li data-type='method'><a href="wsemi.html#.domDrag">domDrag</a></li><li data-type='method'><a href="wsemi.html#.domDragBarAndScroll">domDragBarAndScroll</a></li><li data-type='method'><a href="wsemi.html#.domDragDyn">domDragDyn</a></li><li data-type='method'><a href="wsemi.html#.domDropFiles">domDropFiles</a></li><li data-type='method'><a href="wsemi.html#.domFadeIn">domFadeIn</a></li><li data-type='method'><a href="wsemi.html#.domFadeOut">domFadeOut</a></li><li data-type='method'><a href="wsemi.html#.domFind">domFind</a></li><li data-type='method'><a href="wsemi.html#.domFinds">domFinds</a></li><li data-type='method'><a href="wsemi.html#.domGetBounding">domGetBounding</a></li><li data-type='method'><a href="wsemi.html#.domGetFileAccept">domGetFileAccept</a></li><li data-type='method'><a href="wsemi.html#.domGetFiles">domGetFiles</a></li><li data-type='method'><a href="wsemi.html#.domGetOffset">domGetOffset</a></li><li data-type='method'><a href="wsemi.html#.domIsPageXYIn">domIsPageXYIn</a></li><li data-type='method'><a href="wsemi.html#.domRemove">domRemove</a></li><li data-type='method'><a href="wsemi.html#.domShowInputAndGetFiles">domShowInputAndGetFiles</a></li><li data-type='method'><a href="wsemi.html#.domShowInputAndGetFilesU8Arrs">domShowInputAndGetFilesU8Arrs</a></li><li data-type='method'><a href="wsemi.html#.domTooltip">domTooltip</a></li><li data-type='method'><a href="wsemi.html#.domTriggerEvent">domTriggerEvent</a></li><li data-type='method'><a href="wsemi.html#.downloadExcelFileFromData">downloadExcelFileFromData</a></li><li data-type='method'><a href="wsemi.html#.downloadExcelFileFromDataDyn">downloadExcelFileFromDataDyn</a></li><li data-type='method'><a href="wsemi.html#.downloadFileFromB64">downloadFileFromB64</a></li><li data-type='method'><a href="wsemi.html#.downloadFileFromBlob">downloadFileFromBlob</a></li><li data-type='method'><a href="wsemi.html#.downloadFileFromText">downloadFileFromText</a></li><li data-type='method'><a href="wsemi.html#.downloadFileFromU8Arr">downloadFileFromU8Arr</a></li><li data-type='method'><a href="wsemi.html#.dtmapping">dtmapping</a></li><li data-type='method'><a href="wsemi.html#.dtpick">dtpick</a></li><li data-type='method'><a href="wsemi.html#.evem">evem</a></li><li data-type='method'><a href="wsemi.html#.execScript">execScript</a></li><li data-type='method'><a href="wsemi.html#.f2c">f2c</a></li><li data-type='method'><a href="wsemi.html#.files2data">files2data</a></li><li data-type='method'><a href="wsemi.html#.fsCleanFolder">fsCleanFolder</a></li><li data-type='method'><a href="wsemi.html#.fsCopyFolder">fsCopyFolder</a></li><li data-type='method'><a href="wsemi.html#.fsCreateFolder">fsCreateFolder</a></li><li data-type='method'><a href="wsemi.html#.fsDeleteFolder">fsDeleteFolder</a></li><li data-type='method'><a href="wsemi.html#.fsGetFilesInFolder">fsGetFilesInFolder</a></li><li data-type='method'><a href="wsemi.html#.fsGetFoldersInFolder">fsGetFoldersInFolder</a></li><li data-type='method'><a href="wsemi.html#.fsIsFile">fsIsFile</a></li><li data-type='method'><a href="wsemi.html#.fsIsFolder">fsIsFolder</a></li><li data-type='method'><a href="wsemi.html#.fsReadText">fsReadText</a></li><li data-type='method'><a href="wsemi.html#.fsTreeFolder">fsTreeFolder</a></li><li data-type='method'><a href="wsemi.html#.fsWriteText">fsWriteText</a></li><li data-type='method'><a href="wsemi.html#.genGradientColor">genGradientColor</a></li><li data-type='method'><a href="wsemi.html#.genID">genID</a></li><li data-type='method'><a href="wsemi.html#.genPm">genPm</a></li><li data-type='method'><a href="wsemi.html#.getBufferSize">getBufferSize</a></li><li data-type='method'><a href="wsemi.html#.getDataFromExcelFileU8Arr">getDataFromExcelFileU8Arr</a></li><li data-type='method'><a href="wsemi.html#.getDataFromExcelFileU8ArrDyn">getDataFromExcelFileU8ArrDyn</a></li><li data-type='method'><a href="wsemi.html#.getEnv">getEnv</a></li><li data-type='method'><a href="wsemi.html#.getFileAccept">getFileAccept</a></li><li data-type='method'><a href="wsemi.html#.getGlobal">getGlobal</a></li><li data-type='method'><a href="wsemi.html#.getltdtkeys">getltdtkeys</a></li><li data-type='method'><a href="wsemi.html#.getObjSize">getObjSize</a></li><li data-type='method'><a href="wsemi.html#.getTimeBetween">getTimeBetween</a></li><li data-type='method'><a href="wsemi.html#.getTimeFromUnit">getTimeFromUnit</a></li><li data-type='method'><a href="wsemi.html#.getTimeObject">getTimeObject</a></li><li data-type='method'><a href="wsemi.html#.getTimeRange">getTimeRange</a></li><li data-type='method'><a href="wsemi.html#.getUserAgent">getUserAgent</a></li><li data-type='method'><a href="wsemi.html#.getUserAgentDyn">getUserAgentDyn</a></li><li data-type='method'><a href="wsemi.html#.haskey">haskey</a></li><li data-type='method'><a href="wsemi.html#.hsl">hsl</a></li><li data-type='method'><a href="wsemi.html#.html2pic">html2pic</a></li><li data-type='method'><a href="wsemi.html#.html2picDyn">html2picDyn</a></li><li data-type='method'><a href="wsemi.html#.htmlDecode">htmlDecode</a></li><li data-type='method'><a href="wsemi.html#.htmlEncode">htmlEncode</a></li><li data-type='method'><a href="wsemi.html#.importResources">importResources</a></li><li data-type='method'><a href="wsemi.html#.isab">isab</a></li><li data-type='method'><a href="wsemi.html#.isarr">isarr</a></li><li data-type='method'><a href="wsemi.html#.isarr0">isarr0</a></li><li data-type='method'><a href="wsemi.html#.isblob">isblob</a></li><li data-type='method'><a href="wsemi.html#.isbol">isbol</a></li><li data-type='method'><a href="wsemi.html#.isday">isday</a></li><li data-type='method'><a href="wsemi.html#.isDev">isDev</a></li><li data-type='method'><a href="wsemi.html#.isearr">isearr</a></li><li data-type='method'><a href="wsemi.html#.isEle">isEle</a></li><li data-type='method'><a href="wsemi.html#.isEleExistByID">isEleExistByID</a></li><li data-type='method'><a href="wsemi.html#.isEmail">isEmail</a></li><li data-type='method'><a href="wsemi.html#.iseobj">iseobj</a></li><li data-type='method'><a href="wsemi.html#.iser">iser</a></li><li data-type='method'><a href="wsemi.html#.isernot">isernot</a></li><li data-type='method'><a href="wsemi.html#.isestr">isestr</a></li><li data-type='method'><a href="wsemi.html#.isfun">isfun</a></li><li data-type='method'><a href="wsemi.html#.isint">isint</a></li><li data-type='method'><a href="wsemi.html#.ismonth">ismonth</a></li><li data-type='method'><a href="wsemi.html#.isn0int">isn0int</a></li><li data-type='method'><a href="wsemi.html#.isn0num">isn0num</a></li><li data-type='method'><a href="wsemi.html#.isNarrow">isNarrow</a></li><li data-type='method'><a href="wsemi.html#.isnbr">isnbr</a></li><li data-type='method'><a href="wsemi.html#.isnint">isnint</a></li><li data-type='method'><a href="wsemi.html#.isnull">isnull</a></li><li data-type='method'><a href="wsemi.html#.isnum">isnum</a></li><li data-type='method'><a href="wsemi.html#.isobj">isobj</a></li><li data-type='method'><a href="wsemi.html#.isobj0">isobj0</a></li><li data-type='method'><a href="wsemi.html#.isp0int">isp0int</a></li><li data-type='method'><a href="wsemi.html#.isp0num">isp0num</a></li><li data-type='method'><a href="wsemi.html#.ispint">ispint</a></li><li data-type='method'><a href="wsemi.html#.ispm">ispm</a></li><li data-type='method'><a href="wsemi.html#.isstr">isstr</a></li><li data-type='method'><a href="wsemi.html#.isstr0">isstr0</a></li><li data-type='method'><a href="wsemi.html#.isStrHasCapital">isStrHasCapital</a></li><li data-type='method'><a href="wsemi.html#.isStrHasLowerCase">isStrHasLowerCase</a></li><li data-type='method'><a href="wsemi.html#.isStrHasNumber">isStrHasNumber</a></li><li data-type='method'><a href="wsemi.html#.istime">istime</a></li><li data-type='method'><a href="wsemi.html#.istimeTZ">istimeTZ</a></li><li data-type='method'><a href="wsemi.html#.isu8arr">isu8arr</a></li><li data-type='method'><a href="wsemi.html#.isu16arr">isu16arr</a></li><li data-type='method'><a href="wsemi.html#.isundefined">isundefined</a></li><li data-type='method'><a href="wsemi.html#.isUserIdentify">isUserIdentify</a></li><li data-type='method'><a href="wsemi.html#.isUserName">isUserName</a></li><li data-type='method'><a href="wsemi.html#.isUserPW">isUserPW</a></li><li data-type='method'><a href="wsemi.html#.isWindow">isWindow</a></li><li data-type='method'><a href="wsemi.html#.j2o">j2o</a></li><li data-type='method'><a href="wsemi.html#.keysmat2ltdt">keysmat2ltdt</a></li><li data-type='method'><a href="wsemi.html#.ltdt2vrtsable">ltdt2vrtsable</a></li><li data-type='method'><a href="wsemi.html#.ltdtdiff">ltdtdiff</a></li><li data-type='method'><a href="wsemi.html#.ltdtkeys2mat">ltdtkeys2mat</a></li><li data-type='method'><a href="wsemi.html#.ltdtkeysheads2mat">ltdtkeysheads2mat</a></li><li data-type='method'><a href="wsemi.html#.ltdtmapping">ltdtmapping</a></li><li data-type='method'><a href="wsemi.html#.ltdtmerge">ltdtmerge</a></li><li data-type='method'><a href="wsemi.html#.ltdtpick">ltdtpick</a></li><li data-type='method'><a href="wsemi.html#.ltdtpull">ltdtpull</a></li><li data-type='method'><a href="wsemi.html#.mat2ltdt">mat2ltdt</a></li><li data-type='method'><a href="wsemi.html#.matat">matat</a></li><li data-type='method'><a href="wsemi.html#.now2str">now2str</a></li><li data-type='method'><a href="wsemi.html#.now2strp">now2strp</a></li><li data-type='method'><a href="wsemi.html#.nowDay2str">nowDay2str</a></li><li data-type='method'><a href="wsemi.html#.o2j">o2j</a></li><li data-type='method'><a href="wsemi.html#.obj2b64">obj2b64</a></li><li data-type='method'><a href="wsemi.html#.obj2pb64">obj2pb64</a></li><li data-type='method'><a href="wsemi.html#.obj2str">obj2str</a></li><li data-type='method'><a href="wsemi.html#.obj2stru8arr">obj2stru8arr</a></li><li data-type='method'><a href="wsemi.html#.obj2u8arr">obj2u8arr</a></li><li data-type='method'><a href="wsemi.html#.oo">oo</a></li><li data-type='method'><a href="wsemi.html#.openLink">openLink</a></li><li data-type='method'><a href="wsemi.html#.pb642obj">pb642obj</a></li><li data-type='method'><a href="wsemi.html#.pm2resolve">pm2resolve</a></li><li data-type='method'><a href="wsemi.html#.pmChain">pmChain</a></li><li data-type='method'><a href="wsemi.html#.pmHook">pmHook</a></li><li data-type='method'><a href="wsemi.html#.pmHookReject">pmHookReject</a></li><li data-type='method'><a href="wsemi.html#.pmIni">pmIni</a></li><li data-type='method'><a href="wsemi.html#.pmLast">pmLast</a></li><li data-type='method'><a href="wsemi.html#.pmMap">pmMap</a></li><li data-type='method'><a href="wsemi.html#.pmQueue">pmQueue</a></li><li data-type='method'><a href="wsemi.html#.pmSeries">pmSeries</a></li><li data-type='method'><a href="wsemi.html#.queue">queue</a></li><li data-type='method'><a href="wsemi.html#.rep">rep</a></li><li data-type='method'><a href="wsemi.html#.replace">replace</a></li><li data-type='method'><a href="wsemi.html#.replaceObj">replaceObj</a></li><li data-type='method'><a href="wsemi.html#.replacePlus">replacePlus</a></li><li data-type='method'><a href="wsemi.html#.repObj">repObj</a></li><li data-type='method'><a href="wsemi.html#.round">round</a></li><li data-type='method'><a href="wsemi.html#.sep">sep</a></li><li data-type='method'><a href="wsemi.html#.sepInt">sepInt</a></li><li data-type='method'><a href="wsemi.html#.sepTimeTZ">sepTimeTZ</a></li><li data-type='method'><a href="wsemi.html#.showImages">showImages</a></li><li data-type='method'><a href="wsemi.html#.showImagesDyn">showImagesDyn</a></li><li data-type='method'><a href="wsemi.html#.split">split</a></li><li data-type='method'><a href="wsemi.html#.str2aes">str2aes</a></li><li data-type='method'><a href="wsemi.html#.str2b64">str2b64</a></li><li data-type='method'><a href="wsemi.html#.str2md5">str2md5</a></li><li data-type='method'><a href="wsemi.html#.str2obj">str2obj</a></li><li data-type='method'><a href="wsemi.html#.str2sha512">str2sha512</a></li><li data-type='method'><a href="wsemi.html#.str2u8arr">str2u8arr</a></li><li data-type='method'><a href="wsemi.html#.strClipboard">strClipboard</a></li><li data-type='method'><a href="wsemi.html#.strCompare">strCompare</a></li><li data-type='method'><a href="wsemi.html#.strdelleft">strdelleft</a></li><li data-type='method'><a href="wsemi.html#.strdelright">strdelright</a></li><li data-type='method'><a href="wsemi.html#.strFindFuzz">strFindFuzz</a></li><li data-type='method'><a href="wsemi.html#.strFindFuzzDyn">strFindFuzzDyn</a></li><li data-type='method'><a href="wsemi.html#.strFindSimilar">strFindSimilar</a></li><li data-type='method'><a href="wsemi.html#.strleft">strleft</a></li><li data-type='method'><a href="wsemi.html#.strmid">strmid</a></li><li data-type='method'><a href="wsemi.html#.strright">strright</a></li><li data-type='method'><a href="wsemi.html#.stru8arr2obj">stru8arr2obj</a></li><li data-type='method'><a href="wsemi.html#.time2day">time2day</a></li><li data-type='method'><a href="wsemi.html#.time2expire">time2expire</a></li><li data-type='method'><a href="wsemi.html#.time2hour">time2hour</a></li><li data-type='method'><a href="wsemi.html#.time2min">time2min</a></li><li data-type='method'><a href="wsemi.html#.time2past">time2past</a></li><li data-type='method'><a href="wsemi.html#.timeTZ2day">timeTZ2day</a></li><li data-type='method'><a href="wsemi.html#.timeTZ2hour">timeTZ2hour</a></li><li data-type='method'><a href="wsemi.html#.timeTZ2min">timeTZ2min</a></li><li data-type='method'><a href="wsemi.html#.tinycolor">tinycolor</a></li><li data-type='method'><a href="wsemi.html#.treeObj">treeObj</a></li><li data-type='method'><a href="wsemi.html#.trim">trim</a></li><li data-type='method'><a href="wsemi.html#.u8arr2ab">u8arr2ab</a></li><li data-type='method'><a href="wsemi.html#.u8arr2b64">u8arr2b64</a></li><li data-type='method'><a href="wsemi.html#.u8arr2blob">u8arr2blob</a></li><li data-type='method'><a href="wsemi.html#.u8arr2bs">u8arr2bs</a></li><li data-type='method'><a href="wsemi.html#.u8arr2obj">u8arr2obj</a></li><li data-type='method'><a href="wsemi.html#.u8arr2str">u8arr2str</a></li><li data-type='method'><a href="wsemi.html#.u8arr2u16arr">u8arr2u16arr</a></li><li data-type='method'><a href="wsemi.html#.u16arr2b64">u16arr2b64</a></li><li data-type='method'><a href="wsemi.html#.u16arr2u8arr">u16arr2u8arr</a></li><li data-type='method'><a href="wsemi.html#.urlParse">urlParse</a></li><li data-type='method'><a href="wsemi.html#.verifyValue">verifyValue</a></li><li data-type='method'><a href="wsemi.html#.waitFun">waitFun</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">pmQueue.mjs</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import get from 'lodash/get'
import genPm from './genPm.mjs'
import genID from './genID.mjs'
import pm2resolve from './pm2resolve.mjs'
import queue from './queue.mjs'
import isfun from './isfun.mjs'
import delay from './delay.mjs'


/**
 * 通過佇列限制與呼叫非同步(Promise)函數，可推入不同之非同步函數，將一併受限
 *
 * 可限制同時運行的非同步函數總數量(takeLimit>0)。
 * 可只取最後呼叫的非同步函數進行防抖功能(takeLast=true)，前面的呼叫皆自動轉為catch，回傳訊息為物件{reason:'cancelled'}。
 *
 * Unit Test: {@link https://github.com/yuda-lyu/wsemi/blob/master/test/pmQueue.test.js Github}
 * @memberOf wsemi
 * @param {Integer} [takeLimit=0] 輸入同時處理數量整數，預設0，代表無限制
 * @param {Boolean} [takeLast=false] 輸入多次觸發時是否只取最後呼叫的非同步函數，預設false，搭配takeLimit=0進行非同步函數防抖
 * @returns {Object} 回傳佇列處理器物件，提供run與equip函數供呼叫。run函數的第1參數為非同步函數，第2參數之後(含第3,4,...)為欲輸入非同步函數之參數，多參數時每個用逗號區隔即可，回傳為Promise，resolve回傳成功結果而reject回傳失敗訊息。equip函數輸入為非同步函數，轉換後等待執行，執行時再傳入原本欲輸入非同步函數之參數，回傳為Promise，resolve回傳成功結果而reject回傳失敗訊息，為run的分拆版，非同步函數執行時才推入佇列。
 * @example
 *
 * async function fun1(v) {
 *     console.log('call fun1')
 *     return new Promise(function(resolve, reject) {
 *         setTimeout(function() {
 *             resolve('#' + v)
 *         }, 300)
 *     })
 * }
 *
 * async function fun2(v) {
 *     console.log('call fun2')
 *     return new Promise(function(resolve, reject) {
 *         setTimeout(function() {
 *             reject('#' + v)
 *         }, 200)
 *     })
 * }
 *
 * async function fun3(v) {
 *     console.log('call fun3')
 *     return new Promise(function(resolve, reject) {
 *         setTimeout(function() {
 *             resolve('#' + v)
 *         }, 100)
 *     })
 * }
 *
 * async function testFun1() {
 *     return new Promise((resolve, reject) => {
 *         let ms = []
 *         let q = pmQueue(1) //同時處理1個
 *         q.run(fun1, 'inp1')
 *             .then(function(msg) {
 *                 ms.push('fun1 then ' + msg)
 *                 console.log('fun1 then', msg)
 *             })
 *             .catch(function(msg) {
 *                 ms.push('fun1 catch ' + msg)
 *                 console.log('fun1 catch', msg)
 *             })
 *         q.run(fun2, 'inp2')
 *             .then(function(msg) {
 *                 ms.push('fun2 then ' + msg)
 *                 console.log('fun2 then', msg)
 *             })
 *             .catch(function(msg) {
 *                 ms.push('fun2 catch ' + msg)
 *                 console.log('fun2 catch', msg)
 *             })
 *         q.run(fun3, 'inp3')
 *             .then(function(msg) {
 *                 ms.push('fun3 then ' + msg)
 *                 console.log('fun3 then', msg)
 *             })
 *             .catch(function(msg) {
 *                 ms.push('fun3 catch ' + msg)
 *                 console.log('fun3 catch', msg)
 *             })
 *         setTimeout(function() {
 *             resolve(ms)
 *         }, 650)
 *     })
 * }
 *
 * async function testFun2() {
 *     return new Promise((resolve, reject) => {
 *         let ms = []
 *         let q = pmQueue(2) //同時處理2個
 *         q.run(fun1, 'inp1')
 *             .then(function(msg) {
 *                 ms.push('fun1 then ' + msg)
 *                 console.log('fun1 then', msg)
 *             })
 *             .catch(function(msg) {
 *                 ms.push('fun1 catch ' + msg)
 *                 console.log('fun1 catch', msg)
 *             })
 *         q.run(fun2, 'inp2')
 *             .then(function(msg) {
 *                 ms.push('fun2 then ' + msg)
 *                 console.log('fun2 then', msg)
 *             })
 *             .catch(function(msg) {
 *                 ms.push('fun2 catch ' + msg)
 *                 console.log('fun2 catch', msg)
 *             })
 *         q.run(fun3, 'inp3')
 *             .then(function(msg) {
 *                 ms.push('fun3 then ' + msg)
 *                 console.log('fun3 then', msg)
 *             })
 *             .catch(function(msg) {
 *                 ms.push('fun3 catch ' + msg)
 *                 console.log('fun3 catch', msg)
 *             })
 *         setTimeout(function() {
 *             resolve(ms)
 *         }, 450)
 *     })
 * }
 *
 * async function testFun3() {
 *     return new Promise((resolve, reject) => {
 *         let ms = []
 *         let q = pmQueue(null, true) //同時處理全部, 但只拿最後執行者的結果
 *
 *         let fpm = function (name, t) {
 *             return new Promise(function(resolve, reject) {
 *                 setTimeout(() => {
 *                     resolve('resolve: ' + name)
 *                 }, t)
 *             })
 *         }
 *
 *         //用run直接推函數入佇列並直接執行
 *         q.run(fpm, 'pm1', 150)
 *             .then(function(msg) {
 *                 console.log('pm1 then', msg)
 *                 ms.push('pm1 then: ' + msg)
 *             })
 *             .catch(function(msg) {
 *                 console.log('pm1 catch', msg)
 *                 ms.push('pm1 catch: ' + 'reason ' + msg.reason)
 *             })
 *         q.run(fpm, 'pm2', 100)
 *             .then(function(msg) {
 *                 console.log('pm2 then', msg)
 *                 ms.push('pm2 then: ' + msg)
 *             })
 *             .catch(function(msg) {
 *                 console.log('pm2 catch', msg)
 *                 ms.push('pm2 catch: ' + 'reason ' + msg.reason)
 *             })
 *         q.run(fpm, 'pm3', 50)
 *             .then(function(msg) {
 *                 console.log('pm3 then', msg)
 *                 ms.push('pm3 then: ' + msg)
 *             })
 *             .catch(function(msg) {
 *                 console.log('pm3 catch', msg)
 *                 ms.push('pm3 catch: ' + 'reason ' + msg.reason)
 *             })
 *
 *         setTimeout(() => {
 *             q.run(fpm, 'pm4', 50)
 *                 .then((msg) => {
 *                     console.log('pm4 then', msg)
 *                     ms.push('pm4 then: ' + msg)
 *                 })
 *                 .catch((msg) => {
 *                     console.log('pm4 catch', msg)
 *                     ms.push('pm4 catch: ' + 'reason ' + msg.reason)
 *                 })
 *                 .finally(() => {
 *                     resolve(ms)
 *                 })
 *         }, 200)
 *
 *     })
 * }
 *
 * async function testFun4() {
 *     return new Promise((resolve, reject) => {
 *         let ms = []
 *         let q = pmQueue(null, true) //同時處理全部, 但只拿最後執行者的結果
 *
 *         let fpm = function (name, t) {
 *             return new Promise(function(resolve, reject) {
 *                 setTimeout(() => {
 *                     resolve('resolve: ' + name)
 *                 }, t)
 *             })
 *         }
 *
 *         //用equip事先轉換函數, 之後再依需求執行
 *         let fpm1 = q.equip(fpm)
 *         let fpm2 = q.equip(fpm)
 *         let fpm3 = q.equip(fpm)
 *         let fpm4 = q.equip(fpm)
 *
 *         fpm1('pm1', 150)
 *             .then(function(msg) {
 *                 console.log('pm1 then', msg)
 *                 ms.push('pm1 then: ' + msg)
 *             })
 *             .catch(function(msg) {
 *                 console.log('pm1 catch', msg)
 *                 ms.push('pm1 catch: ' + 'reason ' + msg.reason)
 *             })
 *         fpm2('pm2', 100)
 *             .then(function(msg) {
 *                 console.log('pm2 then', msg)
 *                 ms.push('pm2 then: ' + msg)
 *             })
 *             .catch(function(msg) {
 *                 console.log('pm2 catch', msg)
 *                 ms.push('pm2 catch: ' + 'reason ' + msg.reason)
 *             })
 *         fpm3('pm3', 50)
 *             .then(function(msg) {
 *                 console.log('pm3 then', msg)
 *                 ms.push('pm3 then: ' + msg)
 *             })
 *             .catch(function(msg) {
 *                 console.log('pm3 catch', msg)
 *                 ms.push('pm3 catch: ' + 'reason ' + msg.reason)
 *             })
 *
 *         setTimeout(() => {
 *             fpm4('pm4', 50)
 *                 .then((msg) => {
 *                     console.log('pm4 then', msg)
 *                     ms.push('pm4 then: ' + msg)
 *                 })
 *                 .catch((msg) => {
 *                     console.log('pm4 catch', msg)
 *                     ms.push('pm4 catch: ' + 'reason ' + msg.reason)
 *                 })
 *                 .finally(() => {
 *                     resolve(ms)
 *                 })
 *         }, 200)
 *
 *     })
 * }
 *
 * setTimeout(function() {
 *     console.log('testFun1')
 *     testFun1()
 *         .then((ms) => {
 *             console.log(JSON.stringify(ms))
 *         })
 * }, 1)
 * // testFun1
 * // call fun1
 * // fun1 then #inp1
 * // call fun2
 * // fun2 catch #inp2
 * // call fun3
 * // fun3 then #inp3
 * // ["fun1 then #inp1","fun2 catch #inp2","fun3 then #inp3"]
 *
 * setTimeout(function() {
 *     console.log('testFun2')
 *     testFun2()
 *         .then((ms) => {
 *             console.log(JSON.stringify(ms))
 *         })
 * }, 700)
 * // testFun2
 * // call fun1
 * // call fun2
 * // fun2 catch #inp2
 * // call fun3
 * // fun1 then #inp1
 * // fun3 then #inp3
 * // ["fun2 catch #inp2","fun1 then #inp1","fun3 then #inp3"]
 *
 * setTimeout(function() {
 *     console.log('testFun3')
 *     testFun3()
 *         .then((ms) => {
 *             console.log(JSON.stringify(ms))
 *         })
 * }, 1400)
 * // testFun3
 * // pm3 then resolve: pm3
 * // pm2 catch { reason: 'cancelled' }
 * // pm1 catch { reason: 'cancelled' }
 * // pm4 then resolve: pm4
 * // ["pm3 then: resolve: pm3","pm2 catch: reason cancelled","pm1 catch: reason cancelled","pm4 then: resolve: pm4"]
 *
 * setTimeout(function() {
 *     console.log('testFun4')
 *     testFun4()
 *         .then((ms) => {
 *             console.log(JSON.stringify(ms))
 *         })
 * }, 2100)
 * // testFun4
 * // pm3 then resolve: pm3
 * // pm2 catch { reason: 'cancelled' }
 * // pm1 catch { reason: 'cancelled' }
 * // pm4 then resolve: pm4
 * // ["pm3 then: resolve: pm3","pm2 catch: reason cancelled","pm1 catch: reason cancelled","pm4 then: resolve: pm4"]
 *
 */
function pmQueue(takeLimit = 0, takeLast = false) {
    let gid = null

    //queue
    let q = queue(takeLimit)

    //message
    q.on('message', async function(qs) {
        //console.log('message', qs)

        //get
        let v = q.get()
        if (!v) {
            return
        }

        //delay, 因emit與cb出去後外面promise會慢一點, 故執行前delay釋放同步調用, 使前一個佇列先完成promise
        await delay(1)

        //id
        let id = get(v, 'id')

        //fun
        let fun = get(v, 'fun')

        //input
        let input = get(v, 'input')

        //res
        let res
        if (!isfun(fun)) {
            res = {
                state: 'error',
                msg: 'fun is not function',
            }
        }
        else {
            res = await pm2resolve(fun)(...input)
        }

        //emit
        q.emit(id, res)

        //cb
        q.cb()

    })

    //run
    function run(fun, ...input) {

        //pm
        let pm = genPm()

        //id
        let id = genID()

        //save gid
        gid = id

        //p
        let p = {
            id,
            fun,
            input,
        }

        //push
        q.push(p)

        //once
        q.once(id, (res) => {
            //console.log('once', id, res)
            if (takeLast) {
                if (id === gid) {
                    if (res.state === 'success') {
                        pm.resolve(res.msg)
                    }
                    else {
                        pm.reject(res.msg)
                    }
                }
                else {
                    pm.reject({ reason: 'cancelled' })
                }
            }
            else {
                if (res.state === 'success') {
                    pm.resolve(res.msg)
                }
                else {
                    pm.reject(res.msg)
                }
            }
        })

        return pm
    }

    //equip
    function equip(fun) {
        return function(...input) {
            return run(fun, ...input)
        }
    }

    //save
    q.run = run
    q.equip = equip

    return q
}


export default pmQueue
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Mon Jul 06 2020 11:38:22 GMT+0800 (台北標準時間) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
